<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ZenArt</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
</head>
<body>
  <h1>ZenArt – بازار هنری توکنیزه‌شده</h1>
  <button id="connectBtn">اتصال کیف پول</button>

  <h2>ثبت اثر هنری</h2>
  <input id="title" placeholder="عنوان اثر" />
  <input id="artist" placeholder="نام هنرمند" />
  <input id="description" placeholder="توضیحات" />
  <input id="ipfsHash" placeholder="IPFS Hash" />
  <button id="registerBtn">ثبت اثر</button>

  <h2>امضای اثر</h2>
  <input id="signId" placeholder="شناسه اثر" />
  <button id="signBtn">امضا</button>

  <h2>انتقال مالکیت</h2>
  <input id="transferId" placeholder="شناسه اثر" />
  <input id="newOwner" placeholder="آدرس مالک جدید" />
  <button id="transferBtn">انتقال</button>

  <h2>گالری آثار</h2>
  <div id="gallery"></div>

  <script>
    const contractAddress = "0x03C3b21b3ff382636085AD49026963E17D861F5c";
    const abi = [
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "uint256", "name": "artworkId", "type": "uint256" },
      { "indexed": false, "internalType": "string", "name": "title", "type": "string" },
      { "indexed": true, "internalType": "address", "name": "owner", "type": "address" }
    ],
    "name": "ArtworkRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "uint256", "name": "artworkId", "type": "uint256" },
      { "indexed": true, "internalType": "address", "name": "signer", "type": "address" }
    ],
    "name": "ArtworkSigned",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "uint256", "name": "artworkId", "type": "uint256" },
      { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
      { "indexed": true, "internalType": "address", "name": "to", "type": "address" }
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  {
    "inputs": [
      { "internalType": "string", "name": "_title", "type": "string" },
      { "internalType": "string", "name": "_artist", "type": "string" },
      { "internalType": "string", "name": "_description", "type": "string" },
      { "internalType": "string", "name": "_ipfsHash", "type": "string" }
    ],
    "name": "registerArtwork",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "artworkId", "type": "uint256" }
    ],
    "name": "signArtwork",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "artworkId", "type": "uint256" },
      { "internalType": "address", "name": "newOwner", "type": "address" }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "", "type": "uint256" }
    ],
    "name": "artworks",
    "outputs": [
      { "internalType": "string", "name": "title", "type": "string" },
      { "internalType": "string", "name": "artist", "type": "string" },
      { "internalType": "string", "name": "description", "type": "string" },
      { "internalType": "string", "name": "ipfsHash", "type": "string" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getArtworks",
    "outputs": [
      {
        "components": [
          { "internalType": "string", "name": "title", "type": "string" },
          { "internalType": "string", "name": "artist", "type": "string" },
          { "internalType": "string", "name": "description", "type": "string" },
          { "internalType": "string", "name": "ipfsHash", "type": "string" },
          { "internalType": "address[]", "name": "owners", "type": "address[]" },
          { "internalType": "address[]", "name": "signers", "type": "address[]" }
        ],
        "internalType": "struct ZenArt.Artwork[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "artworkId", "type": "uint256" }
    ],
    "name": "getOwners",
    "outputs": [
      { "internalType": "address[]", "name": "", "type": "address[]" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "artworkId", "type": "uint256" }
    ],
    "name": "getSigners",
    "outputs": [
      { "internalType": "address[]", "name": "", "type": "address[]" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalArtworks",
    "outputs": [
      { "internalType": "uint256", "name": "", "type": "uint256" }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];
    let web3, userAddress, zenArt;

    document.getElementById("connectBtn").onclick = async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        userAddress = (await web3.eth.getAccounts())[0];
        zenArt = new web3.eth.Contract(abi, contractAddress);
        alert("کیف پول متصل شد: " + userAddress);
        loadArtworks();
      } else {
        alert("MetaMask نصب نیست.");
      }
    };

    document.getElementById("registerBtn").onclick = async () => {
      const t = title.value, a = artist.value, d = description.value, h = ipfsHash.value;
      await zenArt.methods.registerArtwork(t, a, d, h).send({ from: userAddress });
      loadArtworks();
    };

    document.getElementById("signBtn").onclick = async () => {
      const id = signId.value;
      await zenArt.methods.signArtwork(id).send({ from: userAddress });
      loadArtworks();
    };

    document.getElementById("transferBtn").onclick = async () => {
      const id = transferId.value;
      const newOwner = newOwner.value;
      await zenArt.methods.transferOwnership(id, newOwner).send({ from: userAddress });
      loadArtworks();
    };

    async function loadArtworks() {
      const data = await zenArt.methods.getArtworks().call();
      gallery.innerHTML = "";
      data.forEach((art, i) => {
        gallery.innerHTML += `
          <div>
            <p><strong>${art.title}</strong> توسط ${art.artist}</p>
            <p>${art.description}</p>
            <p>IPFS: ${art.ipfsHash}</p>
            <p>امضاها: ${art.signers.length}</p>
            <p>مالک‌ها: ${art.owners.join(", ")}</p>
          </div>
          <hr/>
        `;
      });
    }
  </script>
</body>
</html>
