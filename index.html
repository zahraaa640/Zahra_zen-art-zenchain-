<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenChain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
        .logo { max-width: 100px; margin: 10px auto; display: block; }
        .container { max-width: 600px; margin-top: 20px; }
        .btn-custom { background-color: #28a745; border: none; }
        .btn-custom:hover { background-color: #218838; }
        .gallery-item { margin-bottom: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; background: white; }
        .gallery-item img { max-width: 100%; height: auto; border-radius: 4px; }
        #walletStatus { font-weight: bold; }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <img src="IMG20251005132202_322.jpg" alt="ZenChain Logo" class="logo">

    <div class="container text-center">
        <h2>Welcome to ZenChain</h2>
        <p id="walletStatus" class="disconnected">Not connected</p>
        <button id="addNetwork" class="btn btn-outline-primary me-2">Add ZenChain Testnet</button>
        <button id="connectWallet" class="btn btn-custom btn-lg">Connect Wallet</button>

        <div id="registerSection" style="display: none;">
            <h4>Register Artwork</h4>
            <input type="text" id="artworkTitle" class="form-control mb-2" placeholder="Enter artwork title">
            <input type="text" id="artistName" class="form-control mb-2" placeholder="Enter artist name">
            <input type="text" id="description" class="form-control mb-2" placeholder="Enter description">
            <input type="text" id="ipfsHash" class="form-control mb-2" placeholder="Enter IPFS hash (e.g., Qm...)">
            <button id="registerArtwork" class="btn btn-custom btn-lg">Register</button>
        </div>

        <div id="signSection" style="display: none;">
            <h4>Sign Artwork</h4>
            <input type="number" id="artworkIdToSign" class="form-control mb-2" placeholder="Enter artwork ID to sign">
            <button id="signArtwork" class="btn btn-custom btn-lg">Sign</button>
        </div>

        <h4>Gallery</h4>
        <div id="gallery"></div>
    </div>

    <img src="IMG20251005132202_322.jpg" alt="ZenChain Logo" class="logo" style="margin-top: 20px;">

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>
    <script>
        let provider, signer, contract;
        const contractAddress = "0xbd0806D765979C4e9078052aCAa7de3545a398FB";
        const abi = [
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "artworkId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "title",
                        "type": "string"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ArtworkRegistered",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "artworkId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "signer",
                        "type": "address"
                    }
                ],
                "name": "ArtworkSigned",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "_title",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_artist",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_description",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_ipfsHash",
                        "type": "string"
                    }
                ],
                "name": "registerArtwork",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "artworkId",
                        "type": "uint256"
                    }
                ],
                "name": "signArtwork",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "artworks",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "title",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "artist",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "description",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "ipfsHash",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getArtworks",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "string",
                                "name": "title",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "artist",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "description",
                                "type": "string"
                            },
                            {
                                "internalType": "string",
                                "name": "ipfsHash",
                                "type": "string"
                            },
                            {
                                "internalType": "address[]",
                                "name": "owners",
                                "type": "address[]"
                            },
                            {
                                "internalType": "address[]",
                                "name": "signers",
                                "type": "address[]"
                            }
                        ],
                        "internalType": "struct ZenArt.Artwork[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ZenChain Testnet Details (verified from official sources)
        const chainId = 8408;
        const rpcUrl = "https://testnet-rpc.zenchain.io";
        const chainName = "ZenChain Testnet";
        const currencySymbol = "ZTC";
        const explorerUrl = "https://testnet-explorer.zenchain.io";

        async function addZenChainNetwork() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x20e8',  // Hex for 8408
                            chainName: chainName,
                            nativeCurrency: {
                                name: 'ZenChain Token',
                                symbol: currencySymbol,
                                decimals: 18
                            },
                            rpcUrls: [rpcUrl],
                            blockExplorerUrls: [explorerUrl]
                        }]
                    });
                    alert('ZenChain Testnet added! Now connect your wallet.');
                } catch (error) {
                    alert('Failed to add network. Make sure MetaMask is open and try manually via chainlist.org/chain/8408');
                    console.error(error);
                }
            } else {
                alert('Please install MetaMask first!');
            }
        }

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    // Check if on correct chain
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (parseInt(currentChainId, 16) !== chainId) {
                        alert(`Please switch to ZenChain Testnet (Chain ID: ${chainId}). Use the "Add Network" button if needed.`);
                        return;
                    }

                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    contract = new ethers.Contract(contractAddress, abi, signer);

                    document.getElementById("walletStatus").innerHTML = `Connected: ${signer.address.slice(0,6)}...${signer.address.slice(-4)}`;
                    document.getElementById("walletStatus").className = "connected";
                    document.getElementById("connectWallet").disabled = true;
                    document.getElementById("registerSection").style.display = "block";
                    document.getElementById("signSection").style.display = "block";
                    loadGallery();
                } catch (error) {
                    alert('Connection failed: ' + (error.message || 'Please try again. Make sure MetaMask is unlocked.'));
                    console.error(error);
                }
            } else {
                alert('Please install a wallet like MetaMask!');
            }
        }

        async function registerArtwork() {
            if (!contract) return alert("Please connect your wallet first.");
            const title = document.getElementById("artworkTitle").value.trim();
            const artist = document.getElementById("artistName").value.trim();
            const desc = document.getElementById("description").value.trim();
            const ipfs = document.getElementById("ipfsHash").value.trim();

            if (!title || !artist || !desc || !ipfs) {
                return alert("Please fill in all fields. Titles and descriptions can't be empty.");
            }
            if (title.length < 1 || artist.length < 1 || desc.length < 10 || ipfs.length < 5) {
                return alert("Please make sure title/artist are at least 1 char, description 10+ chars, and IPFS hash is valid (starts with Qm...).");
            }

            try {
                const tx = await contract.registerArtwork(title, artist, desc, ipfs);
                alert("Transaction sent! Waiting for confirmation...");
                await tx.wait();
                alert("Artwork registered successfully! Check the gallery.");
                loadGallery();
                clearRegisterInputs();
            } catch (error) {
                let msg = "Registration failed. ";
                if (error.reason) msg += error.reason;
                else if (error.message.includes("reverted")) msg += "Invalid inputs or network issue. Check IPFS hash and try again.";
                else msg += error.message;
                alert(msg);
                console.error(error);
            }
        }

        async function signArtwork() {
            if (!contract) return alert("Please connect your wallet first.");
            const id = parseInt(document.getElementById("artworkIdToSign").value);
            if (!id || id < 0) return alert("Please enter a valid artwork ID (number >= 0).");

            try {
                const tx = await contract.signArtwork(id);
                alert("Transaction sent! Waiting for confirmation...");
                await tx.wait();
                alert("Artwork signed successfully! Check the gallery.");
                loadGallery();
                document.getElementById("artworkIdToSign").value = "";
            } catch (error) {
                let msg = "Signing failed. ";
                if (error.reason) msg += error.reason;
                else if (error.message.includes("already signed")) msg += "You have already signed this artwork.";
                else if (error.message.includes("reverted")) msg += "Artwork doesn't exist or invalid ID.";
                else msg += error.message;
                alert(msg);
                console.error(error);
            }
        }

        async function loadGallery() {
            if (!provider) return;
            try {
                const artworks = await contract.getArtworks();
                const galleryDiv = document.getElementById("gallery");
                galleryDiv.innerHTML = "";
                if (artworks.length === 0) {
                    galleryDiv.innerHTML = "<p>No artworks yet. Register one to start!</p>";
                    return;
                }
                artworks.forEach((artwork, index) => {
                    const item = document.createElement("div");
                    item.className = "gallery-item";
                    const imgSrc = artwork[3] ? `https://ipfs.io/ipfs/${artwork[3]}` : '';  // ipfsHash is index 3 in tuple
                    item.innerHTML = `
                        <h5>ID: ${index}</h5>
                        <h6>${artwork[0]} by ${artwork[1]}</h6>  <!-- title, artist -->
                        <p>${artwork[2]}</p>  <!-- description -->
                        ${imgSrc ? `<img src="${imgSrc}" alt="Artwork" onerror="this.style.display='none'">` : '<p>No image available</p>'}
                        <p><strong>Owners:</strong> ${artwork[4].join(', ') || 'None'}</p>  <!-- owners -->
                        <p><strong>Signers:</strong> ${artwork[5].join(', ') || 'None'}</p>  <!-- signers -->
                    `;
                    galleryDiv.appendChild(item);
                });
            } catch (error) {
                console.error("Gallery load error:", error);
                document.getElementById("gallery").innerHTML = "<p>Failed to load gallery. Try refreshing after connecting.</p>";
            }
        }

        function clearRegisterInputs() {
            document.getElementById("artworkTitle").value = "";
            document.getElementById("artistName").value = "";
            document.getElementById("description").value = "";
            document.getElementById("ipfsHash").value = "";
        }

        // Event Listeners
        document.getElementById("addNetwork").addEventListener("click", addZenChainNetwork);
        document.getElementById("connectWallet").addEventListener("click", connectWallet);
        document.getElementById("registerArtwork").addEventListener("click", registerArtwork);
        document.getElementById("signArtwork").addEventListener("click", signArtwork);

        // Auto-check connection on load
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => location.reload());
            window.ethereum.on('accountsChanged', () => location.reload());
        }
    </script>
</body>
</html>
