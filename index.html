<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZenArt – Tokenized Art Marketplace</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

  <style>
    :root{
      --green: #00cc66;
      --green-dark: #00994d;
      --muted-border: #e6e6e6;
      --bg: #ffffff;
      --text: #111;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: "Helvetica Neue", Arial, sans-serif; direction: rtl;}
    .wrap { display:flex; flex-direction:column; min-height:100vh; align-items:center; }
    .container { width:92%; max-width:960px; margin:18px auto; }
    .logo { display:block; margin:8px auto 6px; max-width:180px; }
    .logo-bottom { width:90%; max-width:720px; margin:18px auto 28px; object-fit:contain; }

    .card { background:#fafafa; border-radius:10px; padding:14px; margin:12px 0; border:1px solid var(--muted-border); box-shadow:0 8px 24px rgba(0,0,0,0.03); }
    .full-input { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; font-size:15px; background:#fff; direction:ltr; }
    .full-btn { width:100%; padding:14px; margin:10px 0; border-radius:8px; border:none; background:var(--green); color:#fff; font-weight:700; font-size:16px; cursor:pointer; }
    .full-btn:hover{ background:var(--green-dark); }
    h2,h3{ margin:10px 0; }
    .muted { color:#666; font-size:13px; text-align:center; }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ border:1px solid #eee; padding:10px; text-align:left; vertical-align:middle; font-size:14px; }
    thead th{ background:#f5f5f5; font-weight:700; }

    .img-thumb{ width:120px; height:80px; object-fit:cover; border-radius:6px; }

    #galleryGrid{ display:flex; flex-direction:column; gap:10px; }
    .gallery-card{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; background:#fff; border:1px solid #eee; }
    .gallery-info{ flex:1; text-align:right; }

    #transactions{ max-height:220px; overflow:auto; padding:8px; background:#fff; border-radius:8px; border:1px solid #eee; text-align:right; }

    @media (max-width:720px){
      .img-thumb{ width:90px; height:60px; }
      .full-input, .full-btn{ font-size:14px; padding:12px; }
      .gallery-card{ flex-direction:column; align-items:flex-start; }
      .gallery-info{ text-align:left; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- top logo -->
    <img src="IMG_20251005_132202_322.jpg" alt="ZenChain Logo" class="logo" />

    <div class="container">
      <h2 style="text-align:center">Welcome to ZenArt</h2>

      <!-- Wallet -->
      <div class="card" id="walletCard">
        <button id="connectButton" class="full-btn">Connect Wallet</button>
        <div id="walletAddress" class="muted" style="margin-top:8px">Not connected</div>
      </div>

      <!-- Register -->
      <div class="card" id="registerCard">
        <h3>Register Artwork</h3>
        <input id="imageHash" class="full-input" placeholder="Image / IPFS Hash (مثلاً Qm... یا URL)" />
        <input id="title" class="full-input" placeholder="Artwork Title (اختیاری)" />
        <input id="artistName" class="full-input" placeholder="Artist Name" />
        <input id="description" class="full-input" placeholder="Description" />
        <button id="registerBtn" class="full-btn">Register</button>
        <div id="registerStatus" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- Actions -->
      <div class="card" id="actionsCard">
        <h3>Artwork Actions</h3>
        <div class="mut
        <input id="actionArtworkId" class="full-input" placeholder="Artwork ID (مثلاً 0)" />
        <button id="likeBtn" class="full-btn">Like</button>
        <button id="signBtn" class="full-btn">Sign</button>

        <div style="margin-top:10px">
          <h4 class="muted">Ownership History Lookup</h4>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="historyId" class="full-input" placeholder="Artwork ID for history" style="flex:1" />
            <button id="historyBtn" class="full-btn" style="width:auto; padding:10px 14px;">Show</button>
          </div>
          <pre id="historyOutput" class="muted" style="margin-top:8px; text-align:right; white-space:pre-wrap;"></pre>
        </div>
      </div>

      <!-- Gallery -->
      <div class="card" id="galleryCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Gallery</h3>
          <div class="muted">Loaded from contract</div>
        </div>
        <div id="galleryGrid"></div>
      </div>

      <!-- Chart -->
      <div class="card" id="chartCard">
        <h3>Most Liked Artworks</h3>
        <div style="width:100%; max-width:820px; margin:0 auto;">
          <canvas id="likesChart"></canvas>
        </div>
      </div>

      <!-- Signature Table -->
      <div class="card" id="sigCard">
        <h3>Signature Table</h3>
        <table id="signatureTable">
          <thead>
            <tr><th style="width:8%">ID</th><th style="width:52%">Title / Description</th><th style="width:20%">Signers</th><th style="width:20%">Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Transactions -->
      <div class="card">
        <h3>Transaction History</h3>
        <div id="transactions" class="muted">Listening for events / loading past events...</div>
      </div>

    </div>

    <!-- bottom logo -->
    <img src="IMG_20251005_132202_322.jpg" alt="ZenChain Footer Logo" class="logo-bottom" />
  </div>

  <script>
  // ------------------------
  // Config: contract address + ABI (from you)
  // ------------------------
  const CONTRACT_ADDRESS = '0x358AA13c52544ECCEF6B0ADD0f801012ADAD5eE3';
  const CONTRACT_ABI = [
	{
		"anonymous": false,
		"inputs": [
			{"indexed": true,"internalType": "uint256","name": "id","type": "uint256"},
			{"indexed": true,"internalType": "address","name": "user","type": "address"}
		],
		"name": "ArtworkLiked","type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{"indexed": true,"internalType": "uint256","name": "id","type": "uint256"},
			{"indexed": true,"internalType": "address","name": "artist","type": "address"}
		],
		"name": "ArtworkRegistered","type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{"indexed": true,"internalType": "uint256","name": "id","type": "uint256"},
			{"indexed": true,"internalType": "address","name": "user","type": "address"}
		],
		"name": "ArtworkSigned","type": "event"
	},
	{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"likeArtwork","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"}],"name":"OwnershipTransferred","type":"event"},
	{"inputs":[{"internalType":"string","name":"_imageHash","type":"string"},{"internalType":"string","name":"_description","type":"string"},{"internalType":"string","name":"_artistName","type":"string"}],"name":"registerArtwork","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"signArtwork","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"},{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"artworks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"imageHash","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"string","name":"artistName","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"likes","type":"uint256"},{"internalType":"uint256","name":"signatures","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getArtwork","outputs":[{"internalType":"string","name":"imageHash","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"string","name":"artistName","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"likes","type":"uint256"},{"internalType":"uint256","name":"signatures","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getOwnershipHistory","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"liked","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"nextArtworkId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"ownershipHistory","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"signed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
  ];

  // ------------------------
  // State
  // ------------------------
  let web3;
  let contract;
  let readContract;
  let accounts = [];
  let likesChart = null;

  // DOM
  const connectButton = document.getElementById('connectButton');
  const walletAddress = document.getElementById('walletAddress');
  const registerBtn = document.getElementById('registerBtn');
  const likeBtn = document.getElementById('likeBtn');
  const signBtn = document.getElementById('signBtn');
  const historyBtn = document.getElementById('historyBtn');

  // helpers
  function shortAddr(a){ if(!a) return ''; a=String(a); return a.slice(0,6)+'...'+a.slice(-4); }
  function ipfsToUrl(h){
    if(!h) return '';
    h = String(h);
    if(h.startsWith('ipfs://')) return 'https://ipfs.io/ipfs/'+h.slice(7);
    if(h.startsWith('Qm') || /^[A-Za-z0-9]{46,}/.test(h)) return 'https://ipfs.io/ipfs/'+h;
    if(h.startsWith('http')) return h;
    return '';
  }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ------------------------
  // Connect wallet
  // ------------------------
  async function connectWallet(){
    try{
      if(!window.ethereum) throw new Error('MetaMask not found');
      web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      accounts = await web3.eth.getAccounts();
      contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS, { from: accounts[0] });
      readContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

      walletAddress.textContent = 'Connected: ' + shortAddr(accounts[0]);
      connectButton.textContent = 'Wallet Connected';
      connectButton.disabled = true;

      // load all UI data
      await loadGallery();
      await loadSignatures();
      await loadTransactions();
      await renderLikesChart();
      setupEventListeners();
    }catch(e){
      console.error('connect error', e);
      alert('Could not connect wallet: '+(e && e.message?e.message:e));
    }
  }

  // ------------------------
  // Register artwork
  // ------------------------
  async function registerArtwork(){
    try{
      if(!contract) return alert('Connect wallet first');
      const imageHash = document.getElementById('imageHash').value.trim();
      const title = document.getElementById('title').value.trim();
      const artistName = document.getElementById('artistName').value.trim();
      const description = (document.getElementById('description').value.trim() || title);
      if(!imageHash || !artistName) return alert('Provide at least IPFS/image and artist name');

      const tx = await contract.methods.registerArtwork(imageHash, description, artistName).send({ from: accounts[0] });
      document.getElementById('registerStatus').textContent = 'Transaction sent. Waiting confirmation...';
      await waitForConfirmation(tx);
      document.getElementById('registerStatus').textContent = 'Registered ✅';
      await loadGallery();
      await loadSignatures();
      await loadTransactions();
      await renderLikesChart();
    }catch(e){ console.error('register failed', e); alert('Register failed: '+(e && e.message?e.message:e)); }
  }

  // ------------------------
  // Like (same as likeArtwork) - from the action input or gallery buttons
  // ------------------------
  async function likeArtworkAction(){
    try{
      if(!contract) return alert('Connect wallet first');
      const idStr = document.getElementById('actionArtworkId').value.trim();
      if(idStr==='') return alert('Enter artwork ID');
      const id = Number(idStr);
      const tx = await contract.methods.likeArtwork(id).send({ from: accounts[0] });
      await waitForConfirmation(tx);
      alert('Liked ✅');
      await loadGallery();
      await loadSignatures();
      await renderLikesChart();
      await loadTransactions();
    }catch(e){ console.error('like failed', e); alert('Like failed: '+(e && e.message?e.message:e)); }
  }

  // ------------------------
  // Sign artwork (counts as a signature)
  // ------------------------
  async function signArtworkAction(){
    try{
      if(!contract) return alert('Connect wallet first');
      const idStr = document.getElementById('actionArtworkId').value.trim();
      if(idStr==='') return alert('Enter artwork ID');
      const id = Number(idStr);
      const tx = await contract.methods.signArtwork(id).send({ from: accounts[0] });
      await waitForConfirmation(tx);
      alert('Signed ✅');
      await loadGallery();
      await loadSignatures();
      await renderLikesChart();
      await loadTransactions();
    }catch(e){ console.error('sign failed', e); alert('Sign failed: '+(e && e.message?e.message:e)); }
  }

  // ------------------------
  // Ownership history
  // ------------------------
  async function showOwnershipHistory(){
    try{
      if(!readContract) return alert('Connect wallet first');
      const idStr = document.getElementById('historyId').value.trim();
      if(idStr==='') return alert('Enter artwork ID');
      const id = Number(idStr);
      const history = await readContract.methods.getOwnershipHistory(id).call();
      if(!history || history.length===0){
        document.getElementById('historyOutput').textContent = 'No ownership history found.';
        return;
      }
      document.getElementById('historyOutput').textContent = history.map((a,i)=>`${i+1}. ${a}`).join('\n');
    }catch(e){ console.error('history failed', e); alert('History fetch failed: '+(e && e.message?e.message:e)); }
  }

  // ------------------------
  // Load gallery (read all artworks)
  // ------------------------
  async function loadGallery(){
    try{
      if(!readContract) readContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
      const nextBN = await readContract.methods.nextArtworkId().call();
      const n = Number(nextBN.toString());
      const galleryGrid = document.getElementById('galleryGrid');
      galleryGrid.innerHTML = '';
      for(let i=0;i<n;i++){
        try{
          const art = await readContract.methods.getArtwork(i).call();
          const imageHash = art[0] || '';
          const desc = art[1] || '';
          const artist = art[2] || '';
          const owner = art[3] || '';
          const likes = art[4] ? Number(art[4].toString()) : 0;
          const signatures = art[5] ? Number(art[5].toString()) : 0;
          const imgUrl = ipfsToUrl(imageHash);

          const card = document.createElement('div');
          card.className = 'gallery-card';

          const img = document.createElement('img');
          img.className = 'img-thumb';
          img.alt = 'art-'+i;
          img.src = imgUrl || 'data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23eee"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="12">No image</text></svg>';

          const info = document.createElement('div');
          info.className = 'gallery-info';
          info.innerHTML = `<div style="font-weight:700">${escapeHtml(artist)} — #${i}</div>
                            <div style="color:#444; margin-top:6px;">${escapeHtml(desc)}</div>
                            <div style="margin-top:8px; color:#666; font-size:13px;">Owner: ${shortAddr(owner)} · Likes: ${likes} · Signs: ${signatures}</div>`;

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.flexDirection = 'column';
          actions.style.gap = '8px';
          actions.style.minWidth = '120px';

          const likeBtnLocal = document.createElement('button');
          likeBtnLocal.className = 'full-btn';
          likeBtnLocal.style.padding = '8px';
          likeBtnLocal.style.fontSize = '14px';
          likeBtnLocal.textContent = 'Like';
          likeBtnLocal.onclick = ()=> { document.getElementById('actionArtworkId').value = i; likeArtworkAction(); };

          const signBtnLocal = document.createElement('button');
          signBtnLocal.className = 'full-btn';
          signBtnLocal.style.padding = '8px';
          signBtnLocal.style.fontSize = '14px';
          signBtnLocal.textContent = 'Sign';
          signBtnLocal.onclick = ()=> { document.getElementById('actionArtworkId').value = i; signArtworkAction(); };

          const viewBtn = document.createElement('button');
          viewBtn.className = 'full-btn';
          viewBtn.style.background = '#eee';
          viewBtn.style.color = '#111';
          viewBtn.style.padding = '8px';
          viewBtn.style.fontSize = '14px';
          viewBtn.textContent = 'View';
          viewBtn.onclick = ()=> { openArtworkDetail(i, ipfsToUrl(imageHash), desc, artist, owner, likes, signatures); };

          actions.appendChild(likeBtnLocal);
          actions.appendChild(signBtnLocal);
          actions.appendChild(viewBtn);

          card.appendChild(img);
          card.appendChild(info);
          card.appendChild(actions);

          galleryGrid.appendChild(card);

        }catch(err){ console.warn('read art failed', i, err); }
      }
    }catch(e){ console.error('loadGallery failed', e); }
  }

  // open detail window
  function openArtworkDetail(id, imgUrl, desc, artist, owner, likes, signatures){
    const w = window.open('', '_blank', 'width=720,height=720');
    w.document.write(`<html><head><title>Artwork ${id}</title></head><body style="font-family:Arial;padding:18px">
      <h2>Artwork #${id}</h2>
      <p><strong>Artist:</strong> ${escapeHtml(artist)}</p>
      <p><strong>Description:</strong> ${escapeHtml(desc)}</p>
      <p><strong>Owner:</strong> ${owner}</p>
      <p><strong>Likes:</strong> ${likes} · <strong>Signatures:</strong> ${signatures}</p>
      ${imgUrl?`<div style="margin-top:12px"><img src="${imgUrl}" style="max-width:100%"></div>`:''}
      </body></html>`);
  }

  // ------------------------
  // Load signature table
  // ------------------------
  async function loadSignatures(){
    try{
      if(!readContract) readContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
      const nextBN = await readContract.methods.nextArtworkId().call();
      const n = Number(nextBN.toString());
      const tbody = document.querySelector('#signatureTable tbody');
      tbody.innerHTML = '';
      for(let i=0;i<n;i++){
        try{
          const art = await readContract.methods.getArtwork(i).call();
          const signers = await readContract.methods.getOwnershipHistory(i).call().catch(()=>[]);
          const signersList = (signers && signers.length) ? signers.join(', ') : (art[5]? `count: ${Number(art[5].toString())}` : '—');

          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i}</td><td>${escapeHtml(art[1] || art[2] || '')}</td><td>${escapeHtml(signersList)}</td>
                          <td>
                            <button style="padding:6px 8px; margin-right:6px;" onclick="document.getElementById('actionArtworkId').value=${i};">Select</button>
                            <button style="padding:6px 8px;background:#eee;" onclick="openArtworkDetail(${i},'${ipfsToUrl(art[0])}','${escapeHtml(art[1]||'')}','${escapeHtml(art[2]||'')}','${art[3]}',${art[4]},${art[5]})">View</button>
                          </td>`;
          tbody.appendChild(tr);
        }catch(err){ console.warn('sig read failed', i, err); }
      }
    }catch(e){ console.error('loadSignatures failed', e); }
  }

  // ------------------------
  // Chart (most liked by likes + signatures)
  // ------------------------
  async function renderLikesChart(){
    try{
      if(!readContract) readContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
      const nextBN = await readContract.methods.nextArtworkId().call();
      const n = Number(nextBN.toString());
      const labels = [];
      const data = [];
      for(let i=0;i<n;i++){
        try{
          const art = await readContract.methods.getArtwork(i).call();
          const title = (art[2] || art[1] || `#${i}`).slice(0,30);
          const likes = art[4] ? Number(art[4].toString()) : 0;
          const signatures = art[5] ? Number(art[5].toString()) : 0;
          labels.push(title+' ('+i+')');
          data.push(likes + signatures); // popularity = likes + signatures
        }catch(e){ labels.push('#'+i); data.push(0); }
      }
      const ctx = document.getElementById('likesChart').getContext('2d');
      if(likesChart) likesChart.destroy();
      likesChart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Popularity (likes + signatures)', data, backgroundColor: 'rgba(0,204,102,0.85)' }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }catch(e){ console.warn('chart failed', e); }
  }

  // ------------------------
  // Transactions (past events)
  // ------------------------
  async function loadTransactions(){
    try{
      const txDiv = document.getElementById('transactions');
      txDiv.innerHTML = 'Loading past events...';
      if(!web3) web3 = new Web3(window.ethereum || null);
      const read = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
      const events = await read.getPastEvents('allEvents', { fromBlock: 0, toBlock: 'latest' });
      events.sort((a,b)=> (b.blockNumber || 0) - (a.blockNumber || 0));
      if(events.length===0){ txDiv.innerHTML = 'No past events found.'; return; }
      txDiv.innerHTML = '';
      events.forEach(ev=>{
        let text='';
        switch(ev.event){
          case 'ArtworkRegistered':
            text = `ArtworkRegistered — id ${ev.returnValues.id} by ${shortAddr(ev.returnValues.artist)}`;
            break;
          case 'ArtworkLiked':
            text = `ArtworkLiked — id ${ev.returnValues.id} by ${shortAddr(ev.returnValues.user)}`;
            break;
          case 'ArtworkSigned':
            text = `ArtworkSigned — id ${ev.returnValues.id} by ${shortAddr(ev.returnValues.user)}`;
            break;
          case 'OwnershipTransferred':
            text = `OwnershipTransferred — id ${ev.returnValues.id} from ${shortAddr(ev.returnValues.from)} to ${shortAddr(ev.returnValues.to)}`;
            break;
          default:
            text = `${ev.event || 'Event'} — ${JSON.stringify(ev.returnValues)}`;
        }
        const p = document.createElement('div');
        p.style.padding='6px 0'; p.style.borderBottom='1px solid #f0f0f0';
        p.textContent = `#${ev.blockNumber} · ${text}`;
        txDiv.appendChild(p);
      });
    }catch(e){ console.error('loadTransactions failed', e); document.getElementById('transactions').innerText = 'Could not load events: '+(e && e.message?e.message:e); }
  }

  // ------------------------
  // Event listeners (live)
  // ------------------------
  function setupEventListeners(){
    try{
      if(!readContract) return;
      readContract.events.ArtworkRegistered({}, (err, ev)=>{ if(!err){ loadGallery(); loadSignatures(); renderLikesChart(); loadTransactions(); } });
      readContract.events.ArtworkLiked({}, (err, ev)=>{ if(!err){ loadGallery(); loadSignatures(); renderLikesChart(); loadTransactions(); } });
      readContract.events.ArtworkSigned({}, (err, ev)=>{ if(!err){ loadGallery(); loadSignatures(); renderLikesChart(); loadTransactions(); } });
      readContract.events.OwnershipTransferred({}, (err, ev)=>{ if(!err){ loadGallery(); loadSignatures(); loadTransactions(); } });
    }catch(e){ console.warn('setup events failed', e); }
  }

  // ------------------------
  // Wait for transaction confirmation (poll)
  // ------------------------
  async function waitForConfirmation(tx){
    try{
      const web3Provider = web3;
      const txHash = tx && (tx.transactionHash || tx.tx);
      if(!txHash) return;
      let receipt = null;
      while(!receipt){
        receipt = await web3Provider.eth.getTransactionReceipt(txHash);
        if(!receipt) await new Promise(r=>setTimeout(r,1000));
      }
      return receipt;
    }catch(e){ console.warn('waitForConfirmation failed', e); }
  }

  // ------------------------
  // Wire UI events
  // ------------------------
  connectButton.addEventListener('click', connectWallet);
  document.getElementById('registerBtn').addEventListener('click', registerArtwork);
  likeBtn.addEventListener('click', likeArtworkAction);
  signBtn.addEventListener('click', signArtworkAction);
  historyBtn.addEventListener('click', showOwnershipHistory);

  // Auto-init if already connected
  (async ()=>{
    try{
      if(window.ethereum){
        web3 = new Web3(window.ethereum);
        const accs = await web3.eth.getAccounts();
        if(accs && accs.length>0){
          accounts = accs;
          contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS, { from: accounts[0] });
          readContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
          walletAddress.textContent = 'Connected: ' + shortAddr(accounts[0]);
          connectButton.textContent = 'Wallet Connected';
          connectButton.disabled = true;
          await loadGallery();
          await loadSignatures();
          await loadTransactions();
          await renderLikesChart();
          setupEventListeners();
        }
      }
    }catch(e){ console.warn('auto init failed', e); }
  })();

  </script>
</body>
</html>
